#INCLUDE "PROTHEUS.CH"
#INCLUDE "RWMAKE.CH"
#INCLUDE "TOTVS.CH"
#INCLUDE "TBICONN.CH"

#DEFINE ENTER CHR(13)+CHR(10)

//------------------------------------------------------------------------------------------'
/*/{Protheus.doc} EZImport
Importa��o e integra��o dos arquivos de lancamentos contabeis

@author    
@version   
@since     25/06/2019 
/*/
//------------------------------------------------------------------------------------------'
User Function EZCapture()

Local oBtnSair
Local oBtnImp
Local nJanAltu := 140
Local nJanLarg := 650
Local oBtnArq
Local nPosEF 
//Local lAtuDic  := If(!ChkFile("Z0G"),AtuaDic(),) 
Private oSayArq
Private oGetArq, cGetArq := Space(200)
Private oDlg
Private lSchedule      := FWGetRunSchedule()  
Private cLogCt2        := "" 
Private aCpos          := {}    
Private aFiles         := {} 
Private cRootPath      := GetSrvProfString("RootPath", "\undefined")   											   
Private cINT085Out     := GetNewPar('EZ_6Q085'  ,'/pwldbms/PRD/WD/INT085/')	
Private cINT085In      := GetNewPar('EZ_6Q085IN','/pwldbms/PRD/WD/INT085/IN/')
Private cLocArq        := '\Journals_6q\entradas\'
Private cLocRet        := '\Journals_6q\retornos\'                                                                          
Private cLocLogs       := '\Journals_6q\logs\'
Private cLocLgEr       := '\Journals_6q\Logs\erro\' 
Private lForcaSchd     := .T.  //GetNewPar('EZ_TMKSCHD' ,.F.)	// Se .T. -> For�a a Execu��o sem a interven��o do usu�rio     
Private aEmpresas      := FWLoadSM0()
Private cEmpFilial     := ''	
Private lMsErroAuto    := .F.
Private lMSHelpAuto    := .F.
Private lAutoErrNoFile := .T.  
Private	aHistory       := { 'Accounting Adjustment'    	  		   	   ,;      // De para de historicos do workday que devem ser rejeitados caso sejam encontrados 							'Ad Hoc Bank Transaction'       		   ,;                                  
							'Ad Hoc Payment'                		   ,;      // nos arquivos                   
							'Asset Assign Accounting'       		   ,;                                  
							'Asset Disposal'                		   ,;                         
							'Asset Issue'                   		   ,;                      
							'Asset Reclassification'        		   ,;                                 
							'Asset Reinstatement'           		   ,;           
							'Asset Removal'                 		   ,;           
							'Bank Account Transfer'         		   ,;           
							'Credit Card Transaction Load'  		   ,;           
							'Customer Cash Sale'            		   ,;           
							'Customer Invoice'              		   ,;           
							'Customer Invoice Payment'      		   ,;           
							'Depreciation'                  		   ,;           
							'Depreciation Adjustment'       		   ,;           
							'Expense Credit Card Payment'   		   ,;           
							'Expense Payment'               		   ,;           
							'Expense Report'                		   ,;           
							'Manual Journal'                		   ,;    
							'Prepaid Spend Amortization'    		   ,;           
							'Receipt Accrual'               		   ,;           
							'Reverse Depreciation'          		   ,;           
							'Supplier Invoice'              		   ,;   
							'Expense Report'                		   ,; 
							'Aulas de francês. Parte do CEO Challenge',;  
							'Bank Fees'  							   ,;								        
							'Supplier Invoice Payment'}
	
//PREPARE ENVIRONMENT EMPRESA "6Q" FILIAL "01" TABLES "CT1","CT2","CT3","CT4","CT5","CTF","CTE" MODULO "CTB"     

Conout("Iniciando EZLeArquivo")

If lForcaSchd
   lSchedule := .F.
Endif			
//-----------------------------------------------------------------------------
// Tratamento para cria��o das pastas -> Schedule
//-----------------------------------------------------------------------------
If !ExistDir('\Journals_6q\')
	MakeDir('\Journals_6q\')
EndIf
	
If !ExistDir(cLocArq)
	MakeDir(cLocArq)
EndIf 

If !ExistDir(cLocRet)
	MakeDir(cLocRet)
Endif                                                                                                                                        

If !ExistDir(cLocLogs)
   MakeDir(cLocLogs)
EndIf
    
If !ExistDir(cLocLgEr)
   MakeDir(cLocLgEr)
EndIf
 	  
//-----------------------------------------------------------------------------      
	
AADD(aCpos,{"DATALCTO"  ,"C",10,0})
AADD(aCpos,{"NUMEROLOT" ,"C",6 ,0})
AADD(aCpos,{"SUBLOTE"   ,"C",3 ,0})
AADD(aCpos,{"NUMERODOC" ,"C",6 ,0})   
AADD(aCpos,{"DESCRICAO" ,"C",60,0})
	
If select("LOGTMP") > 0
   LOGTMP->(DbCloseArea())
EndIf
	
cLogCt2 := CriaTrab(aCpos,.t.)                                      
dbUseArea(.t.,,cLogCt2,"LOGTMP",.F.,.F.) //estrutura do arquivo de log para envio ao sftp temasek.
	
//-----------------------------------------------------------------------------
// FTP para uso no schedule
// Posso realizar uma chamada neste trecho para a rotina de busca no FTP
//-----------------------------------------------------------------------------	
If !lSchedule

    //If Len(Directory ( cLocArq + "*.pgp")) = 0 
		//captura o arquivo encriptado no SFTP e baixa para o servidor HLB e disponibiliza para integra��o.
		Processa( {|| U_CaptureSFTP(cLocArq,cINT085Out,cLocLogs,cLocLgEr)}, "Aguarde...", "Realizando download do arquivo...",.F.) 
	//ENDIF

	DEFINE MSDIALOG oDlg TITLE "Integração de Lançamentos Contábeis" FROM 000, 000  TO nJanAltu, nJanLarg COLORS 0, 16777215 PIXEL
	@ 003, 003     GROUP oGrpPar TO 060, (nJanLarg/2)     PROMPT "Parâmetros: "         OF oDlg COLOR 0, 16777215 PIXEL    
	@ 013, 006 SAY        oSayArq PROMPT "Arquivo:"                  SIZE 060, 007 OF oDlg PIXEL
	@ 010, 070 MSGET      oGetArq VAR    cGetArq                     SIZE 240, 010 OF oDlg PIXEL
	/*oGetArq:bHelp := {||    ShowHelpCpo(    "cGetArq",;
	{"Arquivo CSV que se importado."+STR_PULA+"Exemplo: C:\teste.ent"},2,{},2)}*/
	@ 010, 311 BUTTON oBtnArq PROMPT "..."      SIZE 008, 011 OF oDlg ACTION (U_EZPegaArq(cLocArq)) PIXEL
		
	@ 040, (nJanLarg/2)-(63*1)  BUTTON oBtnSair PROMPT "Sair"      SIZE 60, 014 OF oDlg ACTION (oDlg:End()) PIXEL
	@ 040, (nJanLarg/2)-(63*2)  BUTTON oBtnImp  PROMPT "Integrar"  SIZE 60, 014 OF oDlg ACTION (Processa({|| EZViewFile(), oDlg:End()}, "Aguarde...")) PIXEL

	ACTIVATE MSDIALOG oDlg CENTERED

Else
	//Conout("Schedule -> Inicio Processo")
	Processa({|| EZViewFile()}, "Aguarde...")
	//EZLeArquivo()		
	//Encerra o PREPARE ENVIRONMENT    	    	
	//RESET ENVIRONMENT
EndIf

Return Nil


//------------------------------------------------------------------------------------------
/*/{Protheus.doc} EZLeArquivo
Leitura do(s) arquivo(s)

@author    
@version   
@since     25/06/2019
/*/
//------------------------------------------------------------------------------------------
Static Function EZViewFile()      
    
	Local nBytes
	Local oFile
	Local cLinha	:= ''
	Local nLinha	:= 1
	Local nCont		:= 0
	Local nCabec	:= 0 
	Local nX		:= 1
    Local nY        := 1 
    Local nI        := 1   
    Local nJ        := 1 
    Local nB        := 1 
    Local nQ        := 1  
    Local nR        := 1
	Local nHnd      := 0        
	Local lStruOk 	:= .F. 
    Local lDados    := .F. 
    Local _aCfg		:= {'CT2_DATA','CT2_LOTE'  ,'CT2_SBLOTE','CT2_DOC','CT2_LINHA','CT2_MOEDLC','CT2_DC','CT2_DEBITO','CT2_CREDIT','CT2_VALOR',; 
	     				'CT2_HIST','CT2_TPSALD','CT2_CONVER','CT2_CCD','CT2_CCC'  ,'CT2_ITEMD' ,'CT2_ITEMC' ,'CT2_CLVLDB','CT2_CLVLCR'}              
	Local aCabec    := {}	// Armazeno o cabe�alho para saber a posi��o
	Local Itens	    := {}
	Local aVirgula  := {} 
	Local _aFields  := {}
	Local aFileRet  := {}
	Local aFileUpl  := {}	 
	Local aFileDel  := {}

    aDir(cGetArq,aFiles,,,,,.F.)  //carrega o arquivo selecionado para integrar
     
	For nX := 1 to Len(aFiles)			

	    U_EzDelZ0G(cLocArq+aFiles[nX]) // verifica se ja houve integra��o do arquivo, caso positivo remove todos os registros com status diferentes de '1' na tabela Z0G       
	    
		If lSchedule
		   cGetArq := cLocArq+aFiles[nX]
		Endif		
		
		If File(cGetArq) 
		   FT_FUSE(cGetArq)
		   nBytes := ft_flastrec()                 
		Else		   
		   Conout("Erro ao abrir: "+cGetArq,"Error")
		   Return
		EndIf 
			 
		aCb    := {}                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
		aCabec := {}				                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
		aItens := {}                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
		aItem  := {}			                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
		nLinha := 1                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
		lFirst := .F. 
		//lDados := .F.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
		                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
		ProcRegua(nBytes/30)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
		                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
		conout("Processando arquivo: " + cGetArq)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
		                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
		Do While !FT_FEOF()                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
		                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
			cLinha := FT_FReadLn() // Retorna a linha corrente                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
					                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
			If nLinha < 3                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
			   nLinha++                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
			   ft_fskip()                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
			   Loop                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
			EndIf		                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
						    		                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
			aValores   := {}                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
			aVirgula   := {}                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
			aLinhas    := {}                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
			aPontoVir  := {}                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
			aOcor      := {}                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
			aLin       := {}                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
			aItem      := {}                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
			aMsgProc   := {}
			aDados     := {}                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
			nLp        := 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
			nCont      := 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
			nCt        := 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
			nDados     := 0
		    nPosCod    := 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
			nPosItem   := 0		                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
		    cConteudo  := ''                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           

		    If Len(_aFields) = 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
			   For nI:= 1 To Len(cLinha)				   				   				   				      				                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
				   If SubStr(cLinha,nI,1)==";"                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
				      aAdd(aVirgula,nI)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
				      CpoPlan := AllTrim(SubStr(cLinha,If(nCont==0,1,aVirgula[Len(aVirgula)-1]+1),aVirgula[Len(aVirgula)]-If(nCont==0,1,aVirgula[Len(aVirgula)-1]+1)))						  					                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
				      nCont++                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
				      AADD( _aFields,{CpoPlan})					                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
					EndIf					                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
			   Next nI                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
			                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
		       For nY := Atail(aVirgula) To Atail(aVirgula)	                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
				   If nY < Len(cLinha)					                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
				      CpoPlan := AllTrim(SubStr(cLinha,Atail(aVirgula)+1,Len(cLinha) - nY ) ) 			   		   	                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
				   EndIf					                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
				   AADD( _aFields,{CpoPlan})	  									                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
			   Next nY                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
			                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
			   For _nX := 1 TO Len( _aCfg )                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
			   	   _cName := _aCfg[ _nX ]                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
				   _nRow := aScan( _aFields, { |x| x[ 1 ] == _cName } )                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
				   If _nRow == 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
				      lStruOk := .T.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
					  EXIT                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
				   EndIf                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
			   Next _nX 			   
			   			                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
			   If lStruOk                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
			      //-- Estrutura incorreta - Campo n�o encontrado no arquivo CSV                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  			 	  Conout( "Estrutura incorreta" + _cName + " Campo não encontrado no CSV " )                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
			  	  FT_FUSE()                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
			      Return 			                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
			   EndIf					                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
			   				                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
			EndIf				                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 		   	                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           		   	
		   	
		   	If nLinha > 3		     	                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
			                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
			   For nJ:= 1 To Len(cLinha)				   				   				   				   				                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
				   If SubStr(cLinha,nJ,1)==';'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
				      aAdd(aPontoVir,nJ)			                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
				      cConteudo := AllTrim(SubStr(cLinha,If(nCt==0,1,aPontoVir[Len(aPontoVir)-1]+1),aPontoVir[Len(aPontoVir)]-If(nCt==0,1,aPontoVir[Len(aPontoVir)-1]+1)))						  					   				       	            				       			                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
				      nCt++				   	     			       			                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
				      AAdd(aLinhas,cConteudo)	    			                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
				   EndIf				                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
			   Next nJ 
			   
		       If nCt < Len(_aFields)
				  //cConteudo := AllTrim(SubStr(cLinha,If(nCt==0,1,aPontoVir[Len(aPontoVir)-1]+1),aPontoVir[Len(aPontoVir)]-If(nCt==0,1,aPontoVir[Len(aPontoVir)-1]+1)))						  					   				       	            				       			                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
				  cConteudo := AllTrim(SubStr(cLinha,If(nCt==0,1,aPontoVir[Len(aPontoVir)]  +1),Len(clinha)-If(nCt==0,1,aPontoVir[Len(aPontoVir)-1]+1)))
				  AAdd(aLinhas,cConteudo)			       	 	        			      				    					                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
		       EndIf        			                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
			   
			   If nCt < 18	 //arquivo com estrutura fora do padr�o definido 			  
				  Reclock("LOGTMP",.T.) 						                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
				  LOGTMP->DATALCTO  := Alltrim(aLinhas[1])                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
				  LOGTMP->NUMEROLOT := aLinhas[2]    //Alltrim(aCb[1][2])                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
				  LOGTMP->SUBLOTE   := aLinhas[3]    //aCb[1][3]                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
				  LOGTMP->NUMERODOC := aLinhas[4]    //aCb[1][4]                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
				  LOGTMP->DESCRICAO := "Incorrect data Structure, Please Review."                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
				  LOGTMP->(MsUnlock()) 		                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
				  cChave   := LOGTMP->DATALCTO + LOGTMP->NUMEROLOT + LOGTMP->SUBLOTE + LOGTMP->NUMERODOC
		  		  U_EZESTLOG("CT2"	, cChave , "CONTABIL" , '0'	,cLocArq+aFiles[nX], LOGTMP->DESCRICAO	)  //gera inconsist�ncia		  		  
                  Exit
			   EndIf
			   
			   nPosItem := aScan(aItem,{|x,y,z,k,l| AllTrim(x[1])+AllTrim(x[2])+AllTrim(x[3])+AllTrim(x[4])+AllTrim(x[5]) == AllTrim(aLinhas[1])+AllTrim(aLinhas[2])+AllTrim(aLinhas[3])+AllTrim(aLinhas[4])+AllTrim(aLinhas[5])})
			                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
			   If nPosItem = 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
			      AADD(aItem,aLinhas)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
			   EndIf                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
			                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
			   aAdd(aItens,{{'CT2_DATA'  ,Stod(aItem[Len(aItem)][1])                                ,NIL},;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
			                {'CT2_LOTE'  ,aItem[Len(aItem)][2]                                      ,NIL},;			                 
			                {'CT2_SBLOTE',aItem[Len(aItem)][3] 										,NIL},;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
			                {'CT2_DOC'   ,aItem[Len(aItem)][4] 										,NIL},;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
			                {'CT2_LINHA' ,StrZero(Val(aItem[Len(aItem)][5]),TamSX3('CT2_LINHA')[1]) ,NIL},;					                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
			                {'CT2_MOEDLC',aItem[Len(aItem)][6]							            ,NIL},;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
			                {'CT2_DC'    ,aItem[Len(aItem)][7]							            ,NIL},;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
			                {'CT2_DEBITO',aItem[Len(aItem)][8]							            ,NIL},;					                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
			                {'CT2_CREDIT',aItem[Len(aItem)][9]							            ,NIL},;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
			                {'CT2_VALOR' ,Val(aItem[Len(aItem)][10])  					            ,NIL},;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
			                {'CT2_HIST'  ,aItem[Len(aItem)][11]							            ,NIL},;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
			                {'CT2_TPSALD',aItem[Len(aItem)][12]							            ,NIL},;			                			                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
			                {'CT2_CONVER',aItem[Len(aItem)][13]							            ,NIL},;			                		                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
			                {'CT2_CCD'   ,aItem[Len(aItem)][14]							            ,NIL},;				                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
			                {'CT2_CCC'   ,aItem[Len(aItem)][15]							            ,NIL},;
			                {'CT2_ITEMD' ,aItem[Len(aItem)][16]							            ,NIL},;  					                					                				                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
			                {'CT2_ITEMC' ,aItem[Len(aItem)][17]							            ,NIL},;  
			                {'CT2_CLVLDB',aItem[Len(aItem)][18]							            ,NIL},;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
			                {'CT2_CLVLCR',aItem[Len(aItem)][19]							            ,NIL}})
                                                                                                           
			      cDocAnt :=  AllTrim(aItem[Len(aItem)][1])+AllTrim(aItem[Len(aItem)][2])+AllTrim(aItem[Len(aItem)][3])+AllTrim(aItem[Len(aItem)][4])
			                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
			EndIf                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
			                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
			nLinha++			                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
			ft_fskip()      

			If nLinha = 4 
			   lDados := .F.             
			   cLinha := FT_FReadLn()   			    		   				   				   				   				                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
			   If Empty(Substr(cLinha,1,8))
			      aAdd(aDados,1)
			      lDados := .T.			                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
			   EndIf
			   If Len(aDados) > 0	//gera log de inconsist�ncia.		  
 			      U_EZESTLOG("CT2"	, "" , "CONTABIL" , '3'	,cLocArq+aFiles[nX], "Arquivo contendo somente cabecalho sem linha de dados.")  
				  Conout("Arquivo "+aFiles[nX]+" Arquivo contendo somente cabecalho sem linha de dados !!!")	
				  aDados := {}
				  Exit
			   EndIf
			EndIf						

			If Len(aItem) > 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
			                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
			   cLinha := FT_FReadLn() // Retorna a linha corrente                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
						                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
		       For nB:= 1 To Len(cLinha)				   				   				                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
			       If SubStr(cLinha,nB,1)==';'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
			          aAdd(aOcor,nB)				                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
			          cConte := AllTrim(SubStr(cLinha,If(nLp==0,1,aOcor[Len(aOcor)-1]+1),aOcor[Len(aOcor)]-If(nLp==0,1,aOcor[Len(aOcor)-1]+1)))						  					   				       	            				       			                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
			          nLp++				       			                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
			          AAdd(aLin,cConte)			       			        			      				    					                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
			       EndIf				                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
			   Next nB                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
					                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
			   cDocAtual := If(Empty(cLinha),"",AllTrim(aLin[1])+AllTrim(aLin[2])+AllTrim(aLin[3])+AllTrim(aLin[4]) )                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
									                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
			   If cDocAnt <> cDocAtual .Or. FT_FEOF() .And. cDocAnt == cDocAtual                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
				  lFirst := .T.	                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
			   EndIf                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
				                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
			   If lFirst                                   
				                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
					nPosCod := aScan(aCb,{|x,y,z,k| AllTrim(x[1])+AllTrim(x[2])+AllTrim(x[3])+AllTrim(x[4]) == ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
					           AllTrim(aLinhas[1])+AllTrim(aLinhas[2])+AllTrim(aLinhas[3])+AllTrim(aLinhas[4]) } )				   				                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
					                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
					If nPosCod = 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
					                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
					   AADD(aCb,aLinhas)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
					                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
					   aCab := {{'DDATALANC' ,Stod(aCb[1][1]),NIL},;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
					  	        {'CLOTE'     ,aCb[1][2]      ,NIL},;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
						        {'CSUBLOTE'  ,aCb[1][3]      ,NIL},;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
						        {'CDOC' 	 ,aCb[1][4]      ,NIL},;						      					   					                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
						        {'CPADRAO'   ,''             ,NIL},;						       						       						                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
						        {'NTOTINF'   ,0              ,NIL},;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
						        {'NTOTINFLOT',0              ,NIL}}                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
					           
								cLancto_    := Dtos(aCab[1][2])
								cLote_      := aCab[2][2]
								cSublote_   := aCab[3][2]
								cDocument_  := aCab[4][2]
								cDescricao_ := "document already included"					
                               
					EndIf                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
				    
					If ASCAN(aHistory,aCb[1][11]) > 0  	 //Historico invalido gera log  
					   Reclock("LOGTMP",.T.) 						                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
					   LOGTMP->DATALCTO  := cLancto_                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
					   LOGTMP->NUMEROLOT := cLote_                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
					   LOGTMP->SUBLOTE   := cSublote_                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
					   LOGTMP->NUMERODOC := cDocument_                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
					   LOGTMP->DESCRICAO := 'Journals with history in english'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
					   LOGTMP->(MsUnlock())                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
					   *
					   aCb    := {}					
					   aCab   := {}                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
					   aItens := {}	
				   	   lFirst := .F.					
					   *			   							                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
			           U_EZESTLOG("CT2", cLancto_+cLote_+cSublote_+cDocument_, "CONTABIL" , '0', cLocArq+aFiles[nX],'Journals with history in english')	// 0=Com Erro / 1=Com Sucesso                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
	                                
					ElseIf CT2->( DbSeek(xFilial('CT2')+cLancto_+cLote_+cSublote_+cDocument_) )   //documento ja integrado gera log
					   /* N�o gerar log de retorno de documentos j� contabilizados                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
					   Reclock("LOGTMP",.T.) 						                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
					   LOGTMP->DATALCTO  := cLancto_                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
					   LOGTMP->NUMEROLOT := cLote_                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
					   LOGTMP->SUBLOTE   := cSublote_                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
					   LOGTMP->NUMERODOC := cDocument_                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
					   LOGTMP->DESCRICAO := cDescricao_                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
					   LOGTMP->(MsUnlock())                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
					   */
					   aCb    := {}					
					   aCab   := {}                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
					   aItens := {}	
				   	   lFirst := .F.					
					   //N�o gerar log no monitor 			   							                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
			           //U_EZESTLOG("CT2", cLancto_+cLote_+cSublote_+cDocument_, "CONTABIL" , '3', cGetArq,cDescricao_)	// 0=Com Erro / 1=Com Sucesso                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
			          
			           Conout("Arquivo "+aFiles[nX]+" Lancamento "+cLancto_+" "+cLote_+" "+cSublote_+" "+cDocument_+" ja Integrado")
			        	 	   						                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
					Else                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
					
					   lMsErroAuto  := .F.					   
					   
					   Processa({|| MSExecAuto( {|X, Y ,Z| CTBA102(X, Y, Z)}, aCab    ,aItens , 3) },"Contabilizando Documento... ")
						                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
					   aCab   := {}                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
					   aItens := {}					                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
					   lFirst := .F.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
						                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
					   If lMsErroAuto <> Nil                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
					      If lMsErroAuto                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
		 				       aMsgProc	:= {}                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
						   	  cMsgProc  := ""                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
							  aAutoErro := GETAUTOGRLOG()                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
							  aMsgProc	:= GeraLOG(aAutoErro)  //erro de integra��o gera log                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
							  If Len(aMsgProc) = 5  	                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
								 Reclock("LOGTMP",.T.) 						                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
								 LOGTMP->DATALCTO  := cLancto_    //Alltrim(Dtos(Ctod(aMsgProc[1]) ) )                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
								 LOGTMP->NUMEROLOT := cLote_      //Alltrim(aMsgProc[2])                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
								 LOGTMP->SUBLOTE   := cSubLote_   //Alltrim(aMsgProc[3])                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
								 LOGTMP->NUMERODOC := cDocument_  //Alltrim(aMsgProc[4])                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
								 LOGTMP->DESCRICAO := aMsgProc[5]                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
								 LOGTMP->(MsUnlock())
							  ElseIf Len(aMsgProc) = 1 
 								 Reclock("LOGTMP",.T.) 						                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
								 LOGTMP->DATALCTO  := cLancto_                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
								 LOGTMP->NUMEROLOT := cLote_                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
								 LOGTMP->SUBLOTE   := cSubLote_                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
								 LOGTMP->NUMERODOC := cDocument_                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
								 LOGTMP->DESCRICAO := aMsgProc[Len(aMsgProc)]                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
								 LOGTMP->(MsUnlock())
							  EndIf							   
						  EndIf						                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
						  aCb      := {}                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
						  cStatus  := If(Len(aMsgProc) > 0,'0','1')                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
						  cMsgPlan := If(Len(aMsgProc) > 0,If(Len(aMsgProc) = 1,aMsgProc[1],aMsgProc[5]),"Successfully processed")                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              						  						  
						  cChave   := LOGTMP->DATALCTO + LOGTMP->NUMEROLOT + LOGTMP->SUBLOTE + LOGTMP->NUMERODOC                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          						                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
						  //	   cTabela	  cChave   cProcesso    cStatus	  cArquivo	  cMensagem 
						  *                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
		  				  If Len(aMsgProc) >= 1 
 		  				     U_EZESTLOG("CT2"	,cLancto_+cLote_+cSublote_+cDocument_, "CONTABIL" , cStatus	, cLocArq+aFiles[nX], cMsgPlan	)	// 0=Com Erro / 1=Com Sucesso
   						     Conout("Arquivo "+aFiles[nX]+" Lancamento "+cLancto_+" "+cLote_+" "+cSublote_+" "+cDocument_+" com inconsistencia...")
		  				  ElseIf Len(aMsgProc) = 0
		  				     U_EZESTLOG("CT2", cLancto_+cLote_+cSublote_+cDocument_, "CONTABIL" , cStatus,cLocArq+aFiles[nX],cMsgPlan)	// 0=Com Erro / 1=Com Sucesso
		  				     Conout("Arquivo "+aFiles[nX]+" Lancamento "+cLancto_+" "+cLote_+" "+cSublote_+" "+cDocument_+" Integrado")
		  			      EndIf
					   EndIf 					   						                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
					EndIf	                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
			   EndIf		                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
								                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
			EndIf							                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
		                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
		Enddo
	                                         
	    Ft_Fuse()
		//--------------------------------------------------------------------------------
		// Gera��o do arquivo de retorno, tendo como base principal os dados de origem
		//--------------------------------------------------------------------------------
        lReprocessa := .F.
            		
	   	GeraCSV() //Gera arquivo CSV com incosistencia na pasta retorno	para Upload SFTP
	    
 	    If lDados  //Se arquivo enviado estiver sem linha de dados Renomear.
		   Conout("Schedule -> Renomeado arquivo: "+aFiles[nX]+" pasta: "+ cLocArq)  
		   fRename(cLocArq+aFiles[nX],cLocArq+Substr(aFiles[nX],1,Rat(".csv",aFiles[nX]))+'int',,.F.) //Renomeia o arquivo da pasta entrada para integrado.  	    
           fRename(cLocArq+aFiles[nX]+'.pgp',cLocArq+Substr(aFiles[nX]+".pgp",1,Rat(".pgp",aFiles[nX]+".pgp"))+'dcp',,.F.) //Renomeia o arquivo criptografado na pasta entrada para decriptado.    			      	      	    
	    Else   	        
	       If LOGTMP->(Reccount()) > 0	//Arquivo com inconsit�ncia para ser analisado       
		      MsgAlert("Arquivo com Rejeicao,favor analisar.")
			  fRename(cLocArq+aFiles[nX]+'.pgp',cLocArq+Substr(aFiles[nX]+".pgp",1,Rat(".pgp",aFiles[nX]+".pgp"))+'dcp',,.F.) //Renomeia o arquivo criptografado na pasta entrada para decriptado.
              /*
			  If MsgYesNo("Reprocessa","Arquivo com inconsistência") 
			     //lReprocessa := .T.			     
				 If File(cLocArq+aFiles[nX])    //se houver arquivo processado 
                    fErase(cLocArq+aFiles[nX])  //remover o arquivo remover, para reprocessamento.
                 EndIf				 				 
			  Else  //se nao reprocessar  		   
	   		     //lReprocessa := .F.	   
			     fRename(cLocArq+aFiles[nX],cLocArq+Substr(aFiles[nX],1,Rat(".csv",aFiles[nX]))+'int',,.F.) //Renomeia o arquivo da pasta entrada para integrado.    
			     fRename(cLocArq+aFiles[nX]+'.pgp',cLocArq+Substr(aFiles[nX]+".pgp",1,Rat(".pgp",aFiles[nX]+".pgp"))+'dcp',,.F.) //Renomeia o arquivo criptografado na pasta entrada para decriptado.
			  EndIf  
			  */
		   Else   //Arquivo sem inconsit�ncia para ser analisado renomear    
			  fRename(cLocArq+aFiles[nX],cLocArq+Substr(aFiles[nX],1,Rat(".csv",aFiles[nX]))+'int',,.F.) //Renomeia o arquivo da pasta entrada para integrado se n�o houver rejei��o.    
			  fRename(cLocArq+aFiles[nX]+'.pgp',cLocArq+Substr(aFiles[nX]+".pgp",1,Rat(".pgp",aFiles[nX]+".pgp"))+'dcp',,.F.) //Renomeia o arquivo criptografado na pasta entrada para decriptado.
		   EndIf	
        EndIf
		If lDados 
	       MsgInfo("Arquivo sem linha de dados.","Contabilizacao")
	    ElseIf !lDados	    
	       MsgInfo("Contabilizacao finalizada.","Contabilizacao")					
	    EndIf   	
	
	Next nX                                                       	
	
	If lForcaSchd                                                             
		
		If Len(aFiles) == 0
		   Conout("Não Foram Encontrados arquivos na pasta")            
	    EndIf
	    
	    Conout("Processamento finalizado!")
	     
	Endif	
	
Return 


//------------------------------------------------------------------------------------------
/*/{Protheus.doc} EZPegaArq
Exibe arquivos no diret�rio para integra��o, arquivos com extens�o csv.

@author     
@version    
@since     26/06/2019
/*/
//------------------------------------------------------------------------------------------
*
User Function EZPegaArq(cDiretorio)

Local cArqAux := ""  

cArqAux := cGetFile( "Arquivo Texto *.csv | *.csv",;    //Mascara
"Arquivo...",;                        					//Titulo
,;                                   				    //Numero da mascara
cDiretorio,;                               			    //Diretario Inicial
.F.,;                   			    	         	//.F. == Abrir; .T. == Salvar 
GETF_LOCALHARD,;              				       		//Diretrio full. Ex.: 'C:\TOTVS\arquivo.xlsx'
.T.)                                					//Nao exibe diretrio do servidor
cGetArq := PadR(cArqAux,200)
oGetArq:Refresh()

Return

//------------------------------------------------------------------------------------------
/*/{Protheus.doc} SchedDef
//Fun��o para utiliza��o no Schedule 
@author Marcio Martins pereira
@since 07/05/2019
@version 1.00
@type function
/*/
//------------------------------------------------------------------------------------------
Static Function SchedDef()

	Local _aPar 	:= {}		//array de retorno
	Local _cFunc	:= "EZIMPORT"
	Local _cPerg	:= PadR(_cFunc, 10)
	_aPar := { 	"P"		,;	//Tipo R para relatorio P para processo
	_cPerg	,;	//Nome do grupo de perguntas (SX1)
	Nil		,;	//cAlias (para Relatorio)
	Nil		,;	//aArray (para Relatorio)
	Nil		}	//Titulo (para Relatorio)

Return _aPar 


//------------------------------------------------------------------------------------------
/*/{Protheus.doc} GeraLOG
Fun��o para tratar o log de processamento
@author     
@version    
@since     26/06/2019
/*/
//------------------------------------------------------------------------------------------
Static Function GeraLOG(aAutoErro)  
    
Local cRet        := "" 
Local cRetInvalid := "" 
Local nX          := 1  
Local aRetMsg     := {}   
Local aRetAjuda   := {}

If Len(aAutoErro) > 0    
    nVezes := If(At("AJUDA",aAutoErro[1]) > 0,7,6)
	For nX := 1 to Len(aAutoErro)	
		If nX < nVezes 
		   If At("AJUDA",aAutoErro[nX]) > 0 .Or. At("Tabela",aAutoErro[nX]) > 0
		      If At("Tabela",aAutoErro[nX]) > 0 
		         nX := 2
		      ElseIf At("AJUDA",aAutoErro[nX]) > 0   
		         nX := 3
		      EndIf
		      
		      If At("Invalido",aAutoErro[nX]) > 0  
		         aRetAjuda := {}
		         cRet := substr(aAutoErro[nX],At(':=',aAutoErro[nX])+2,(At('<',aAutoErro[nX])-1) - ( At(':=',aAutoErro[nX])+2)  )
		         AADD(aRetMsg,cRet)
		         AADD(aRetAjuda,aAutoErro[nX])		         
		      ElseIf At(':=',aAutoErro[nX])> 0
		         cRet := substr(aAutoErro[nX],At(':=',aAutoErro[nX])+2,12 )
		         AADD(aRetMsg,cRet)  
		      ElseIf At('Inconsistencia',aAutoErro[nX])> 0   
		         cRet := "Inconsistency in line items" //Alltrim(aAutoErro[nX])	
		         AADD(aRetMsg,cRet)  	         
		      EndIf
		   Else
		      If At("Invalido",aAutoErro[nX]) > 0  
		         cRet := substr(aAutoErro[nX],At(':=',aAutoErro[nX])+2,(At('<',aAutoErro[nX])-1) - ( At(':=',aAutoErro[nX])+2)  )
		         AADD(aRetMsg,cRet) 
		      ElseIf  At(':=',aAutoErro[nX])> 0
		         cRet := substr(aAutoErro[nX],At(':=',aAutoErro[nX])+2,10 )
		         AADD(aRetMsg,cRet)
		      ElseIf At('Inconsistencia',aAutoErro[nX])> 0                    
		         cRet := "Inconsistency in line items" //Alltrim(aAutoErro[nX])	      
		         AADD(aRetMsg,cRet)      		         
		      EndIf		        
		   EndIf   
		Else	
		   If At("Invalido",aAutoErro[nX]) > 0
			  cRetInvalid += RetTraduc(Alltrim(aAutoErro[nX]),.T.)
		   	  AADD(aRetMsg,cRetInvalid)
		   EndIf
		   If At("Erro -->",aAutoErro[nX]) > 0
			  cRetInvalid += If(At('Inconsistencia',aAutoErro[nX])> 0,"Inconsistency in line items",Alltrim(aAutoErro[nX]) )
		   	  AADD(aRetMsg,cRetInvalid)
		   EndIf 
		   If Len(aRetAjuda) > 0
			  cRetInvalid += RetTraduc(Alltrim(aRetAjuda[Len(aRetAjuda)]),.F.)
		   	  AADD(aRetMsg,cRetInvalid)
		   	  aRetAjuda := {}		   
		   EndIf		   
	    EndIf
	Next nX 
EndIf                       
Return aRetMsg 

//------------------------------------------------------------------------------------------
/*/{Protheus.doc} GeraCSV
Gera��o de CSV de rejei��o

@author    
@version   
@since     25/06/2019
/*/
//------------------------------------------------------------------------------------------
Static function GeraCSV()                          
Local _cAlias := "LOGTMP"        
Local cText   := "Workday_Journals_"
Local nPsText := AT(UPPER(cText),UPPER(cGetArq))
Local cHora   := Alltrim(SubStr(cGetArq,nPsText+Len(cText),100))	// Retorno data e hora do arquivo original 
Local cNomLog := cLocRet+"Microsiga_JournalErrorLog_"+cHora
Local nHandle := 0
Local nX      := 0
Local nQ      := 0 
Local lSai    := .F.    

If File(cNomLog)    //se houver arquivo processado excluir para reprocessamento.
   fErase(cNomLog)  //remover o arquivo
EndIf

nHandle := If(LOGTMP->(Reccount()) > 0,FCreate(cNomLog,,,.F.),0)

If nHandle > 0
         
   // Grava o cabecalho do arquivo       
   aEval(aCpos, {|e, nX| fWrite(nHandle, If(aCpos[nX,1]=="DESCRICAO","<Error Description>",e[1]) + If(nX <= Len(aCpos), ";", ""))})   
   fWrite(nHandle, ENTER ) // Pula linha
      
   (_cAlias)->(dbgotop())
   while (_cAlias)->(!eof())
	
	For nQ := 1 to Len(aCpos)	      
		IF aCpos[nQ][2] == "C"
		   _uValor := (_cAlias)->&(aCpos[nQ][1])      
		ELSE
		   _uValor := (_cAlias)->&(aCpos[nQ][1])
		ENDIF		
        
        If nQ <= len(aCpos)
           fWrite(nHandle, _uValor + ";" )
        EndIf
	Next nQ
	
    fWrite(nHandle,ENTER )
               
    (_cAlias)->(dbskip())
               
   EndDo
   Conout("Gerado Arquivo de Log: "+cNomLog+" Pasta: "+cLocRet)  
EndIf          
fClose(nHandle)   



//------------------------------------------------------------------------------------------
/*/{Protheus.doc} RetTraduc
Retorna a tradu��o do erro "Invalido" apresentado no retorno do execauto. 

@author    
@version   
@since     18/07/2019
/*/
//------------------------------------------------------------------------------------------
Static Function RetTraduc(cConteudo,Flag)

Local cCampo  := If(Flag,SubStr(cConteudo,24,10),Subst(cConteudo,At('-',cConteudo)+1,10) )
Local cString := If(Flag,Posicione("SX3",2,cCampo,"X3_TITENG"),'')
Local cRet 	  := If(Flag,cString + " - " + cCampo + ' '+StrTran(SubStr(cConteudo,37),"Invalido","Invalid"),cCampo + StrTran(cConteudo,"Invalido","Invalid")  ) 

Return cRet                                

//------------------------------------------------------------------------------------------
/*/{Protheus.doc} GerSFTP.
Realiza a conex�o com SFTP Temasek,e executa as opera��es de captura,exclus�o,grava��o.
 
@author    
@version   
@since     18/07/2019
/*/
//------------------------------------------------------------------------------------------
User Function GerSFTP(cOper,cArqSFPT,cDirSRV,cDirSFTP,cLocLogs,cLocLgEr)
Local lRet      := .F.
Local cCommando := ""
Local lWait     := .T.
Local cPath     := 'C:\Program Files (x86)\WinSCP\'
Local cRootPath := GetSrvProfString("RootPath", "\undefined")
Local cBat      := ""                                            
Local cArqLog   := ""
Local cBatWscpJ := "" 
Local cDataLog  := StrTran(dTos(dDataBase), '/', '-')+StrTran(Time(), ':','')
Local nR        := 0

cBatWscpJ := "\WiscpconnectJ.bat"
 
//Cria arquivo bat para subir arquivo no FTP.
nHdl := FCREATE(cBatWscpJ,0 )  //Cria��o do Arquivo txt.                                                  
If nHdl == -1 // Testa se o arquivo foi gerado
   cMsg:="O bat "+cBatWscpJ+" nao pode ser executado."
   conout(cMsg)
   Return lRet
EndIf  
cCommando:= '@echo off'+ENTER
cCommando+= ENTER
cCommando+= '"C:\Program Files (x86)\WinSCP\WinSCP.com" ^'+ENTER
cCommando+= '  /log="'+cRootPath+cLocLogs+'WinSCPconnect.log" /ini=nul ^'+ENTER        																 
cCommando+= '  /command ^'+ENTER                                                                                                                
//cCommando+= ' "open sftp://mgsvcaprd1@sftp.temasek.com.sg/ -hostkey=""ssh-rsa 2048 1fy/vFSSs7R+Ijttc9Tkr/w26UQmRSsRUDDWDjrXkK4="" -privatekey=""C:\Users\protheus\Desktop\mgsvcaprd1.ppk  "" -rawsettings FSProtocol=2" ^'+ENTER 
cCommando+= ' "open sftp://mgsvcaprd1@sftp.temasek.com.sg/ -hostkey=""ssh-rsa 2048 1fy/vFSSs7R+Ijttc9Tkr/w26UQmRSsRUDDWDjrXkK4="" -privatekey=""C:\Users\protheus\Documents\mgsvcaprd1.ppk"" -rawsettings FSProtocol=2" ^'+ENTER
If cOper = 'GET' .Or. cOper = 'DEL' 
   cCommando+= '    "cd '+cDirSFTP+'" ^'+ENTER       
EndIf 
If cOper = 'GET'  
   cCommando+= '    "'+cOper+' *.pgp '+cRootPath+cDirSRV+'" ^'+ENTER
ElseIf cOper = 'DEL'  
   cCommando+= '    "get -delete '+Alltrim(cArqSFPT)+'" ^'+ENTER   
ElseIf cOper = 'PUT'
   cCommando+= '    "lcd '+cRootPath+cDirSRV+'" ^'+ENTER   
   cCommando+= '    "cd '+cDirSFTP+'" ^'+ENTER
   cCommando+= '    "'+cOper+' '+cRootPath+cDirSRV+Alltrim(cArqSFPT)+'" ^'+ENTER
EndIf                 
cCommando+= '    "exit"' +ENTER
cCommando+= ENTER
cCommando+= 'set WINSCP_RESULT=%ERRORLEVEL%'+ENTER
cCommando+= 'if %WINSCP_RESULT% equ 0 ('+ENTER
cCommando+= '  echo Success'+ENTER
cCommando+= ') else ('+ENTER
cCommando+= '  echo Error'+ENTER
cCommando+= '  Move '+cRootPath+cLocLogs+'WinSCPconnect.log '+cRootPath+cLocLgEr+'WinSCPconnect.log'+ENTER  
cCommando+= ')'+ENTER
cCommando+= ENTER
cCommando+= 'exit /b %WINSCP_RESULT%'+ENTER
fWrite(nHdl,cCommando)//Escreve no arquivo 
fclose(nHdl)//Fecha o arquivo
lRet := WaitRunSrv( @cRootPath+cBatWscpJ , @lWait , @cPath )
fErase(cBatWscpJ)//Apaga o .Bat
Return lRet
//------------------------------------------------------------------------------------------
/*/{Protheus.doc} CaptureSFTP.
Realiza Download do arquivo no SFTP Temasek,grava na pasta de entrada,decripta e remove do SFTP Temasek. 
 
@author    Sandro Silva
@version   
@since     18/07/2019
/*/
//------------------------------------------------------------------------------------------
User Function CaptureSFTP(cPasta,cOrigem,cLogs,cLogErr)
    
U_GerSFTP('GET',"*.pgp",cPasta,cOrigem,cLogs,cLogErr)  			          //captura o arquivo encriptado no SFTP e baixa para o servidor local.            
If Len(Directory ( cPasta + "*.pgp")) <> 0  
   Conout("Schedule -> Descriptando arquivo(s) pasta: "+cPasta)         
   //U_HLBGEN01("D","Temasek_Protheus",cRootPath+cPasta,"*.pgp","hlb@2019") //descripta o arquivo capturado para integra��o.  
   U_HLBGEN01("D","hlb_sistemas",cRootPath+cPasta,"*.pgp","hlb@2020") //descripta o arquivo capturado para integra��o.  
   Conout("Schedule -> Removendo arquivo(s) SFTP: "+cOrigem)      
   U_GerSFTP('DEL',"*.pgp",cPasta,cOrigem,cLogs,cLogErr)				  //remove o arquivo na pasta do SFTP ap�s a captura. 
EndIf   
Return
